# Part IV: Detailed Functional Workflows

## 4.1. Workflow: Sending a Message (Text & Voice)

This workflow describes how users send messages, including rich media and voice notes.

### A. Initiating a Conversation (User A -> User B)

- **Trigger:** User A clicks "Send Whisper" on User B's profile.
- **Check Existing:** Client checks if a conversation already exists between A and B.
- **Create (if needed):** If not, Client A calls `mutation conversations.create(userId: B_Id)`.
  - Returns `conversationId`.
- **Upload Media (Optional):**
  - **Image:** Calls `mutation generateUploadUrl` -> Uploads file -> Gets `storageId`.
  - **Voice:** Calls `mutation generateVoiceUploadUrl` -> Uploads audio blob -> Gets `audioStorageId`.
- **Send Message:**
  - Client calls `mutation messages.send(...)` with content and optional storage IDs.
- **Update UI:**
  - Optimistic update shows the message immediately.
  - Convex subscription confirms the message is saved.

### B. Receiving a Message (User B)

- **Real-time Update:**
  - User B is subscribed to `query messages.list(conversationId)`.
  - When User A sends a message, Convex pushes the new message to User B's client.
- **Notification:**
  - If User B is not in the chat view, a notification indicator appears (handled by `query conversations.list` with unread counts).

## 4.2. Workflow: Echo Chambers (Group Chat)

### A. Creating an Echo Chamber

- **Trigger:** User clicks "Create Chamber".
- **Form:** Enters Name, Topic, and Description.
- **Action:** Client calls `mutation echoChambers.create`.
- **Result:** Returns `chamberId` and a unique `inviteCode`.

### B. Joining a Chamber

- **Trigger:** User enters an `inviteCode` or finds a Public Chamber.
- **Action:** Client calls `mutation echoChambers.join(inviteCode)`.
- **Alias:** User is assigned an anonymous alias (e.g., "Whisper #7") specific to that chamber.
- **Access:** User can now read/write messages in that chamber.

## 4.3. Workflow: Skill Exchange

### A. Offering a Skill

- **Trigger:** User navigates to "Skills" -> "Offer Skill".
- **Form:** Enters Skill Name (e.g., "Next.js") and Proficiency.
- **Action:** Client calls `mutation skills.add(type="offering")`.

### B. Seeking a Mentor

- **Trigger:** User searches for a skill.
- **Query:** Client calls `query skills.search(skillName)`.
- **Match:** App displays anonymized users offering that skill.
- **Connect:** User clicks "Request Mentorship".
- **Action:** Client calls `mutation skillMatches.request(teacherId)`.

## 4.4. Workflow: Unmasking Ceremony

### A. Initiating Unmasking

- **Context:** Active conversation between Use A and User B.
- **Trigger:** User A clicks "Request Unmasking".
- **Action:** Client calls `mutation unmasking.request(conversationId)`.
- **State:** Conversation enters "Unmasking Pending" state for User A.

### B. Accepting Unmasking

- **Trigger:** User B sees "Unmasking Requested" notification in chat.
- **Action:** User B clicks "Accept Reveal".
- **Result:**
  - Both users' real `displayName` and `avatarUrl` are revealed in the chat header.
  - Profile link becomes active.

## 4.5. Workflow: Admin Privilege Elevation

### A. User Requests Admin Access

- **Trigger:** User navigates to Settings → "Request Admin Access".
- **Form:** User provides reason for wanting admin privileges.
- **Submit:** Client calls `mutation admin.requestAdminPromotion(reason)`.
- **Storage:** Request stored with `status: "pending"`.
- **Confirmation:** User sees "Request submitted" message.

### B. Super Admin Reviews Request

- **Trigger:** Super Admin navigates to Admin Dashboard → Requests.
- **Query:** Client calls `query admin.getPendingAdminRequests`.
- **Review:** Super Admin sees list of pending requests with reasons.
- **Action:**
  - **Approve:** `mutation admin.approveAdminRequest(requestId)` → Creates `adminRole` record.
  - **Reject:** `mutation admin.rejectAdminRequest(requestId)` → Updates request status.
- **Notification:** Requesting user's next login shows updated status.

### C. Direct Admin Grant (Alternative)

- **Trigger:** Super Admin navigates to Admin Dashboard → Users.
- **Search:** Super Admin enters username.
- **Grant:** Super Admin clicks "Grant Admin" → `mutation admin.grantAdminRole(username)`.
- **Result:** User immediately has admin access.

## 4.6. Workflow: Admin Whisper Monitoring

- **Trigger:** Admin navigates to `/admin/whispers`.
- **Load:** Client calls `query admin.getAllWhispers(cursor, limit, filters)`.
- **Display:** Table shows timestamp, sender username, recipient username, content preview.
- **Expand:** Admin clicks row to expand.
- **Detail Query:** Client calls `query admin.getWhisperDetails(whisperId)`.
- **Full View:** Panel displays:
  - Complete message content
  - Sender profile (username, email, career)
  - Recipient profile (username, email, career)
  - Sent timestamp, read status, read timestamp
- **Pagination:** Admin scrolls/pages to load more whispers.
