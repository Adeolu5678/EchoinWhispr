# Part IV: Detailed Functional Workflows

## 4.1. Workflow: Sending a Message (with Images)

This workflow describes how users send messages, including rich media, using Convex.

### A. Initiating a Conversation (User A -> User B)

- **Trigger:** User A clicks "Send Whisper" on User B's profile.
- **Check Existing:** Client checks if a conversation already exists between A and B.
- **Create (if needed):** If not, Client A calls `mutation conversations.create(userId: B_Id)`.
  - Returns `conversationId`.
- **Upload Image (Optional):**
  - If User A attaches an image:
    1. Client calls `mutation generateUploadUrl`.
    2. Client uploads file to the returned URL.
    3. Client receives `storageId`.
- **Send Message:**
  - Client calls `mutation messages.send(conversationId, content, type="text/image", storageId?)`.
- **Update UI:**
  - Optimistic update shows the message immediately.
  - Convex subscription confirms the message is saved.

### B. Receiving a Message (User B)

- **Real-time Update:**
  - User B is subscribed to `query messages.list(conversationId)`.
  - When User A sends a message, Convex pushes the new message to User B's client.
- **Notification:**
  - If User B is not in the chat view, a notification indicator appears (handled by `query conversations.list` with unread counts).

## 4.2. Workflow: Search and Discovery

- **Trigger:** User enters search terms.
- **Debounce:** Client waits for 300ms of inactivity.
- **Query:** Client calls `query users.search(term)`.
- **Display:** Results are displayed instantly.

## 4.3. Workflow: Subscription Upgrade

- **Trigger:** User selects "Premium Plan".
- **Mutation:** Client calls `mutation subscriptions.createCheckoutSession(planId)`.
- **Redirect:** Client redirects user to the returned Stripe URL.
- **Webhook:** Stripe calls the API webhook upon success.
- **Update:** Webhook calls internal mutation to update user's `subscriptionStatus`.
- **Client Update:** User's client automatically reflects the new status via reactive query.

## 4.4. Workflow: Admin Privilege Elevation

### A. User Requests Admin Access

- **Trigger:** User navigates to Settings → "Request Admin Access".
- **Form:** User provides reason for wanting admin privileges.
- **Submit:** Client calls `mutation admin.requestAdminPromotion(reason)`.
- **Storage:** Request stored with `status: "pending"`.
- **Confirmation:** User sees "Request submitted" message.

### B. Super Admin Reviews Request

- **Trigger:** Super Admin navigates to Admin Dashboard → Requests.
- **Query:** Client calls `query admin.getPendingAdminRequests`.
- **Review:** Super Admin sees list of pending requests with reasons.
- **Action:**
  - **Approve:** `mutation admin.approveAdminRequest(requestId)` → Creates `adminRole` record.
  - **Reject:** `mutation admin.rejectAdminRequest(requestId)` → Updates request status.
- **Notification:** Requesting user's next login shows updated status.

### C. Direct Admin Grant (Alternative)

- **Trigger:** Super Admin navigates to Admin Dashboard → Users.
- **Search:** Super Admin enters username.
- **Grant:** Super Admin clicks "Grant Admin" → `mutation admin.grantAdminRole(username)`.
- **Result:** User immediately has admin access.

## 4.5. Workflow: Admin Whisper Monitoring

- **Trigger:** Admin navigates to `/admin/whispers`.
- **Load:** Client calls `query admin.getAllWhispers(cursor, limit, filters)`.
- **Display:** Table shows timestamp, sender username, recipient username, content preview.
- **Expand:** Admin clicks row to expand.
- **Detail Query:** Client calls `query admin.getWhisperDetails(whisperId)`.
- **Full View:** Panel displays:
  - Complete message content
  - Sender profile (username, email, career)
  - Recipient profile (username, email, career)
  - Sent timestamp, read status, read timestamp
- **Pagination:** Admin scrolls/pages to load more whispers.
