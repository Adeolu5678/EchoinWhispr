# Part III: Data Models & Database Schema

## 3.1. Database Schema (Convex)

The application uses Convex as its backend and database. The schema is defined in `convex/schema.ts`.

### Users Table (`users`)

| Field | Type | Description |
|-------|------|-------------|
| `tokenIdentifier` | `string` | Unique identifier from Clerk (indexed). |
| `career` | `string` | User's career (e.g., "Software Engineer"). |
| `interests` | `array<string>` | List of user interests. |
| `mood` | `string` | Current mood status. |
| `subscriptionStatus` | `string` | "free", "premium", etc. |
| `subscriptionEnds` | `number` | Timestamp of subscription expiry. |
| `isOnline` | `boolean` | Online status indicator. |

### Conversations Table (`conversations`)

| Field | Type | Description |
|-------|------|-------------|
| `participantIds` | `array<Id<"users">>` | IDs of users in the conversation. |
| `lastMessageId` | `Id<"messages">` | Pointer to the last message for sorting. |
| `updatedAt` | `number` | Timestamp of last activity. |

### Messages Table (`messages`)

| Field | Type | Description |
|-------|------|-------------|
| `conversationId` | `Id<"conversations">` | Parent conversation ID (indexed). |
| `senderId` | `Id<"users">` | ID of the sender. |
| `content` | `string` | Text content of the message. |
| `type` | `string` | "text" or "image". |
| `storageId` | `string` | (Optional) Convex Storage ID for images. |
| `createdAt` | `number` | Timestamp. |

## 3.2. Backend Functions (Convex)

### User Functions

- **`register`**: Creates a new user record linked to the authenticated Clerk identity.
- **`updatePersona`**: Updates career, interests, and mood.
- **`getProfile`**: Fetches user profile data.
- **`search`**: Full-text search on career and interests.

### Messaging Functions

- **`sendMessage`**: Creates a new message, updates the conversation's `lastMessageId` and `updatedAt`.
- **`getMessages`**: Paginated query for messages in a conversation.
- **`createConversation`**: Initializes a new conversation between two users.

### Subscription Functions

- **`upgrade`**: Handles subscription upgrades via Stripe.
- **`checkStatus`**: Verifies active subscription.

## 3.3. File Storage

Images are stored in Convex File Storage.

- **Upload**: Client requests an upload URL via `generateUploadUrl`, uploads the file, and then sends the `storageId` with the message.
- **Retrieval**: Client uses the `storageId` to fetch the image URL.

## 3.4. Admin System Tables

### Admin Roles Table (`adminRoles`)

| Field | Type | Description |
|-------|------|-------------|
| `userId` | `Id<"users">` | Reference to the user (indexed). |
| `clerkId` | `string` | Clerk identifier for quick auth lookup (indexed). |
| `role` | `"admin" \| "super_admin"` | Admin privilege level. |
| `grantedBy` | `Id<"users">` | (Optional) Who granted the role. |
| `createdAt` | `number` | Timestamp of promotion. |

### Admin Requests Table (`adminRequests`)

| Field | Type | Description |
|-------|------|-------------|
| `userId` | `Id<"users">` | Requesting user (indexed). |
| `clerkId` | `string` | Clerk identifier. |
| `reason` | `string` | User's reason for requesting admin. |
| `status` | `"pending" \| "approved" \| "rejected"` | Request status (indexed). |
| `reviewedBy` | `Id<"users">` | (Optional) Super admin who reviewed. |
| `reviewedAt` | `number` | (Optional) Review timestamp. |
| `createdAt` | `number` | Request timestamp. |

## 3.5. Admin Functions (Convex)

### Admin Request Functions

- **`requestAdminPromotion`**: User submits request with reason.
- **`getPendingAdminRequests`**: Super admin sees pending requests.
- **`approveAdminRequest`**: Super admin approves, creates adminRole record.
- **`rejectAdminRequest`**: Super admin rejects request.

### Admin Management Functions

- **`grantAdminRole`**: Super admin directly grants admin to a user by username.
- **`revokeAdminRole`**: Super admin revokes admin privileges.
- **`isCurrentUserAdmin`**: Check if authenticated user has admin role.

### Admin Monitoring Functions

- **`getAllWhispers`**: Paginated query returning all whispers with sender/recipient usernames.
- **`getWhisperDetails`**: Returns full whisper data including sender/recipient profiles, emails, timestamps.
- **`getAdminDashboardStats`**: Returns platform statistics (total users, whispers, today's activity).
