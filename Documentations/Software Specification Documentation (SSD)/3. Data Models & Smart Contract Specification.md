# Part III: Data Models & Database Schema

**Version:** 2.2 (Updated to Match Codebase)
**Date:** February 5, 2026

## 3.1. Database Schema (Convex)

The application uses Convex as its backend and database. The schema is defined in `convex/schema.ts` and includes comprehensive support for social features, group messaging, and complex interactions.

### Core User Data

#### Users Table (`users`)
Basic user identity and profile information.

| Field | Type | Description |
|-------|------|-------------|
| `clerkId` | `string` | Unique identifier from Clerk (indexed). |
| `username` | `string` | Unique username (indexed). |
| `email` | `string` | User email address (indexed). |
| `firstName` | `string` | Optional. |
| `lastName` | `string` | Optional. |
| `displayName` | `string` | Public display name. |
| `career` | `string` | User's career/profession (indexed). |
| `interests` | `array<string>` | List of user interests. |
| `mood` | `string` | Current mood status (indexed). |
| `lifePhase` | `string` | E.g., 'student', 'career-change' (indexed). |
| `moodJournal` | `array<object>` | History of user moods with timestamps. |
| `themePreference` | `string` | "light", "dark", or "system". |
| `pushNotificationToken` | `string` | For mobile push notifications (indexed). |
| `isDeleted` | `boolean` | Soft-delete flag for GDPR compliance. |

### Messaging & Social Graph

#### Whispers Table (`whispers`)
Direct messages between users (1-on-1).

| Field | Type | Description |
|-------|------|-------------|
| `senderId` | `Id<"users">` | Sender ID (indexed). |
| `recipientId` | `Id<"users">` | Recipient ID (indexed). |
| `content` | `string` | Message content. |
| `conversationId` | `Id<"conversations">` | Link to parent conversation (optional). |
| `imageUrl` | `string` | Optional image attachment. |
| `audioStorageId` | `Id<"_storage">` | Voice message storage ID. |
| `audioDuration` | `number` | Duration of voice message in seconds. |
| `isVoiceModulated` | `boolean` | Whether voice masking was applied. |
| `scheduledFor` | `number` | Timestamp for scheduled delivery. |
| `isMystery` | `boolean` | Flag for "Mystery Whisper" feature. |
| `reactions` | `array<object>` | Emoji reactions from users. |

#### Conversations Table (`conversations`)
Metadata for 1-on-1 chat threads.

| Field | Type | Description |
|-------|------|-------------|
| `participantIds` | `array<Id<"users">>` | IDs of the two participants. |
| `status` | `string` | "initiated", "active", "closed" (indexed). |
| `isPinned` | `boolean` | User preference for pinning. |
| `isArchived` | `boolean` | Archive status. |

#### Friends Table (`friends`)
Explicit friendship connections.

| Field | Type | Description |
|-------|------|-------------|
| `userId` | `Id<"users">` | Initiator or subject. |
| `friendId` | `Id<"users">` | The other user. |
| `status` | `string` | "pending", "accepted", "blocked" (indexed). |

### Specialized Features

#### Echo Chambers (`echoChambers`)
Anonymous group messaging rooms based on topics.

| Field | Type | Description |
|-------|------|-------------|
| `name` | `string` | Display name of the chamber. |
| `topic` | `string` | Subject matter (indexed). |
| `creatorId` | `Id<"users">` | Creator of the chamber. |
| `inviteCode` | `string` | Unique code for joining (indexed). |
| `maxMembers` | `number` | Member limit. |
| `isPublic` | `boolean` | Discoverable in search. |

#### Skill Exchange (`skills` & `skillMatches`)
Marketplace logic for mentorship and learning.

| Field | Type | Description |
|-------|------|-------------|
| `userId` | `Id<"users">` | Owner of the skill listing. |
| `skillName` | `string` | Name of the skill (search indexed). |
| `type` | `string` | "offering" (Teacher) or "seeking" (Student). |
| `proficiencyLevel` | `string` | "beginner", "expert", etc. |

#### Unmasking Requests (`unmaskingRequests`)
"Unmasking Ceremony" flow to reveal real identities.

| Field | Type | Description |
|-------|------|-------------|
| `requesterId` | `Id<"users">` | User initiating the unmasking. |
| `targetId` | `Id<"users">` | User being asked to unmask. |
| `status` | `string` | "pending", "accepted", "declined". |

### Admin & System

#### Admin Roles (`adminRoles`) & Requests (`adminRequests`)
Role-based access control.
- `role`: "admin" or "super_admin".
- `requestType`: "admin" or "super_admin".

#### Feature Flags (`featureFlags`)
Remote configuration for enabling/disabling features.
- `name`: Feature key (e.g., "WHISPER_CHAINS").
- `enabled`: Boolean status.

## 3.2. Core Backend Functions (Convex)

### User & Social
- **`softDeleteUser`**: GDPR compliance â€“ anonymizes user data.
- **`findMoodMatch`**: Advanced algorithms for matching based on mood.
- **`toggleReaction`**: Add/remove emoji reactions to whispers.

### Messaging Extended
- **`sendVoiceWhisper`**: Handles voice metadata and rate limiting.
- **`scheduleWhisper`**: Queues messages for future timestamps.
- **`processScheduledWhispers`**: CRON job to deliver queued messages.
- **`replyToWhisper`**: Handles "Whisper Chains" logic.

### Admin
- **`softDeleteUser` (Admin Mode)**: Allows admins to ban/delete users.
- **`grantAdminRole` / `revokeAdminRole`**: Super admin primitives.
- **`getAdminDashboardStats`**: Aggregated analytics.

## 3.3. File Storage Strategy
- **Images**: Stored via `generateUploadUrl` -> `imageUrl` string.
- **Voice**: Stored via `generateVoiceUploadUrl` -> `audioStorageId`.
- **Optimization**: Files are delivered via Convex's built-in CDN.

