# Functional Requirements (MVP & Future Iterations)

This section provides a detailed breakdown of the application's required functionalities, distinguishing between the immediate Minimum Viable Product (MVP) and features planned for future iterations, which will have foundational "window-spaces" implemented early.

3.1. User Authentication (MVP)
The application will provide secure and streamlined user authentication using Clerk.

3.1.1. User Registration (Sign-Up)
Requirement ID: FR-AUTH-001
Description: Users must be able to create a new account within the application.
Preconditions: User is on the sign-up screen, has network connectivity.
Postconditions: User account is created in Clerk, user is logged in, redirected to home.
User Story: As a new user, I want to create an account so I can start sending and receiving whispers.
Flow (Web/React Native):
User navigates to the dedicated sign-up screen/modal.
User inputs a valid email address into the designated field.
User inputs a strong password (minimum 8 characters, combination of uppercase, lowercase, numbers, symbols) into the password field.
User confirms password (optional, depending on Clerk UI defaults).
(Optional) User accepts terms of service/privacy policy if presented.
User clicks/taps the "Sign Up" button.
System Action: Client-side validation is performed on email format and password strength.
System Action: If client-side validation passes, a request is sent to the Clerk API for user registration.
System Action: Clerk processes the registration, creates the user, and securely handles password hashing.
System Action: Upon successful registration, Clerk provides a session token.
System Action: Client-side, the session token is securely stored (handled by Clerk SDK).
System Action: User's clerkUserId and email are automatically synced to Convex's users table via Clerk's webhooks or direct integration. A username and displayName will be generated based on the email (e.g., first part of email).
User is automatically logged into the application.
User is redirected to the main application's home screen.
Data Inputs: email (string), password (string).
Data Outputs: New user record in Clerk and Convex.
Error Handling:
Display clear, user-friendly error messages for invalid input (e.g., "Invalid email format," "Password too weak").
Handle and display errors from Clerk API (e.g., "Email already in use," "Registration failed, please try again").

3.1.2. User Login (MVP)
Requirement ID: FR-AUTH-002
Description: Existing users must be able to log in to their accounts.
Preconditions: User has an existing account, has network connectivity.
Postconditions: User is authenticated, session is established, redirected to home.
User Story: As an existing user, I want to log in to my account so I can access my whispers.
Flow (Web/React Native):
User navigates to the login screen/modal.
User inputs their registered email address into the designated field.
User inputs their password into the password field.
User clicks/taps the "Log In" button.
System Action: Client-side validation (e.g., email format) is performed.
System Action: If client-side validation passes, a request is sent to the Clerk API for user authentication.
System Action: Clerk verifies credentials.
System Action: Upon successful authentication, Clerk provides a session token.
System Action: Client-side, the session token is securely stored (handled by Clerk SDK).
User is logged into the application.
User is redirected to the main application's home screen.
Data Inputs: email (string), password (string).
Data Outputs: Authenticated user session.
Error Handling:
Display clear, user-friendly error messages for invalid input.
Handle and display errors from Clerk API (e.g., "Invalid credentials," "Account not found").

3.1.3. Session Management (MVP)
Requirement ID: FR-AUTH-003
Description: User sessions must be securely managed, allowing users to remain logged in across application launches until they explicitly log out or their session expires.
User Story: As a returning user, I want to stay logged in so I don't have to re-enter my credentials every time I open the app.
Mechanism: Clerk's SDK will handle secure session storage (e.g., using secure cookies for web, secure storage for React Native), token refreshing, and session expiry logic. The application will leverage Clerk's built-in session management features, minimizing custom implementation.

3.2. Core Messaging: Whispers (MVP)
The heart of the EchoinWhispr platform, focusing on the anonymous, one-way text message exchange.

3.2.1. Sending a Whisper (MVP)
Requirement ID: FR-WHISP-001
Description: Authenticated users must be able to compose and send a new Whisper.
Preconditions: User is logged in, has network connectivity.
Postconditions: Whisper is sent and stored in Convex, visible to the recipient.
User Story: As a logged-in user, I want to send an anonymous text message to another user so I can share my thoughts without revealing my identity immediately.
Flow (Web/React Native):
User navigates to a "Compose Whisper" screen or activates a compose modal.
User inputs text content into a TextInput field (Web) or TextInput component (React Native).
Constraint: Text content is limited to a maximum of 280 characters. Client-side character count display and enforcement are required.
User must specify a recipient. For the MVP, this will be a simple input field where the user types the username or email of the intended recipient.
User clicks/taps a "Send Whisper" button.
System Action: Client-side validation checks if the text content is not empty and within character limits, and if a recipient is specified.
System Action: If client-side validation passes, a Convex mutation (API call) is initiated to persist the whisper. This mutation will include textContent, senderId (derived from the current authenticated user's ID, which Convex will keep anonymous for recipients), and receiverId (looked up from users table based on the input username/email).
System Action: Convex stores the whisper in the whispers table, automatically adding createdAt and setting status to sent.
System Action: Upon successful API response, a transient success message (e.g., a toast notification) is displayed to the sender.
User is then returned to the main application home screen or the compose field is cleared.
Data Inputs: textContent (string), recipientIdentifier (string: username/email).
Data Outputs: New whisper record in Convex.
Error Handling:
Display clear error messages for validation failures (e.g., "Whisper too long," "Recipient not found").
Handle and display network errors or Convex API failures (e.g., "Failed to send whisper, please try again").

3.2.2. Receiving a Whisper (MVP)
Requirement ID: FR-WHISP-002
Description: Authenticated users must be able to view Whispers sent to them in real-time.
Preconditions: User is logged in, has network connectivity.
Postconditions: User can see new whispers addressed to them.
User Story: As a logged-in user, I want to see any new anonymous messages sent to me as soon as they arrive so I can stay updated.
Flow (Web/React Native):
User navigates to their primary "Inbox" or home screen, which displays a list of incoming whispers.
System Action: The application establishes a Convex live query for whispers where the receiverId matches the currently authenticated user's ID and status is not read.
System Action: Convex streams new or updated whispers to the client in real-time.
System Action: New whispers are dynamically added to the displayed list, typically at the top.
A visual indicator (e.g., a "new whisper" badge or unread styling) is presented for unread whispers.
Upon viewing a whisper (e.g., tapping to expand, or after a brief duration of it being visible on screen), the whisper's status in Convex is updated to read via a Convex mutation, and readAt timestamp is set.
Data Inputs: None (query-driven).
Data Outputs: List of whisper records from Convex.
Error Handling:
Gracefully handle network disconnections and re-establish live queries upon reconnection.
Display an empty state message if no whispers are present.

3.2.3. Displaying Whispers (MVP)
Requirement ID: FR-WHISP-003
Description: Whispers will be displayed in a clean, readable, and consistent format.
Preconditions: User is viewing a list of whispers.
Postconditions: Whispers are presented clearly.
User Story: As a user, I want to easily read and understand the messages in my inbox.
UI Elements (Web/React Native):
Each whisper will be presented as a distinct card or list item.
The textContent will be the prominent element, displayed clearly.
The createdAt timestamp (formatted for readability, e.g., "2 minutes ago", "Aug 28, 2025") will be visible.
The sender's identity will be displayed as "Anonymous" or a similar non-identifiable placeholder for MVP.
A visual indicator (e.g., a subtle background color or an icon) for unread whispers.

3.3. Deferred Features (Foundation-First Approach)
The following features are deferred from the MVP but will have architectural "window-spaces" or foundational code implemented during the initial build, controlled by feature flags. AI agents will be instructed to structure the code in a way that allows for easy activation and full implementation later. Each of these features will be toggled by a specific feature flag (e.g., FEATURE_FLAGS.CONVERSATION_EVOLUTION).

3.3.1. Conversation Evolution (Whisper to Echoed Whisper)
Requirement ID: FR-DEFER-001
Description: The ability for a recipient of a Whisper to "Echo" it back, initiating a two-way, mutually revealed conversation where both parties' identities become known.
Foundation:
UI Placeholders: Include a button or UI element (e.g., an "Echo Back" button) on a Whisper detail view, initially disabled or hidden.
Convex Schema Extensions: The whispers table will include an optional conversationId field. A conversations table will be defined in the Convex schema, though not actively used for mutations in MVP.
Feature Flag: CONVERSATION_EVOLUTION (set to false for MVP).

3.3.2. Image Uploads (Whisper Content & Profile Pictures)
Requirement ID: FR-DEFER-002
Description: The ability for users to attach images to whispers or upload profile pictures.
Foundation:
Whisper Content: A UI icon or placeholder in the "Compose Whisper" screen for image attachment will be present but inactive or visually disabled. The whispers table schema in Convex will include an optional imageUrl field.
Profile Pictures: A dedicated UI section for a user's profile picture will be present (e.g., a circular image placeholder) within the profile screen, but the functionality to select, upload, and display an image will be inactive. The users table schema in Convex will include an optional profileImageUrl field.
Feature Flag: IMAGE_UPLOADS, PROFILE_PICTURES (both set to false for MVP).
Contingency: If AI agents encounter recurrent or complex errors during the foundation implementation of these placeholders and schema extensions, the entire "window-space" can be removed for the MVP to prioritize a lean release. This decision will be logged in the AI Agent Logbook.

3.3.3. User Profile Management (Beyond Basic Authentication)
Requirement ID: FR-DEFER-003
Description: Comprehensive user profile features, including the ability to edit display name, bio, and other personal settings.
Foundation: A basic "Profile" screen will be implemented with read-only displays of username, displayName, and a placeholder for bio. Fields will be structured to easily convert to editable inputs when this feature is activated.
Feature Flag: USER_PROFILE_EDITING (set to false for MVP).

3.3.4. Push Notifications
Requirement ID: FR-DEFER-004
Description: Real-time alerts to users for new whispers, conversation updates, etc. (Mobile-specific feature for ReactNative).
Foundation: The necessary Expo modules (expo-notifications) for push notifications will be integrated into the ReactNative project. Code to request notification permissions from the user and to register the device's push token with Convex (storing it in the users table) will be included but not actively used for sending notifications in the MVP.
Feature Flag: PUSH_NOTIFICATIONS (set to true for foundation, false for active sending in MVP).

3.3.5. Location-Based Features
Requirement ID: FR-DEFER-005
Description: Future integration of location-specific functionalities (e.g., sharing location in a whisper if explicitly opted-in). Note: The administrative feature to track user device information and location has been explicitly removed from scope.
Foundation: Code to request basic location permissions from the user will be present in the ReactNative project. The whispers table schema will include an optional location field (object: {latitude: number, longitude: number}). No actual location sharing functionality will be active in the MVP.
Feature Flag: LOCATION_BASED_FEATURES (set to true for foundation, false for active use in MVP).

3.3.6. Whisper Chains
Requirement ID: FR-DEFER-006
Description: The ability for users to continue their own whisper threads by replying to their own whispers, enabling storytelling and long-form content creation while bypassing the 280-character limit. Each reply maintains anonymity and creates a chain of related whispers.
Foundation:
UI Placeholders: Include a "Reply to Self" button or UI element on whisper detail views and compose screens, initially disabled or hidden. A chain view component will be present but inactive to display whisper threads.
Convex Schema Extensions: The whispers table will include an optional parentWhisperId field (Convex ID reference to whispers table) to link replies to their parent whispers. A chainId field will group related whispers into chains.
Feature Flag: WHISPER_CHAINS (set to false for MVP).
Security & Privacy Considerations:
Anonymity Maintenance: Replies within chains must maintain sender anonymity to recipients, even though the sender knows they are replying to themselves.
Rate Limiting: Implement server-side rate limiting on chain creation to prevent abuse (e.g., maximum 10 replies per chain, maximum 5 chains per user per day).
Data Isolation: Chain data must be properly isolated; users can only view and reply to their own chains.
Performance Considerations: Implement efficient querying for chain retrieval with pagination to handle long chains without impacting app responsiveness.
UI/UX Requirements:
Chain Navigation: Provide intuitive navigation between whispers in a chain (e.g., "Previous" and "Next" buttons, breadcrumb trail).
Visual Indicators: Display chain length and position (e.g., "Part 3 of 5") in whisper views.
Compose Flow: When composing a chain reply, show the parent whisper context and allow unlimited character input with clear warnings about anonymity.

3.3.7. Mystery Whispers
Requirement ID: FR-DEFER-007
Description: The ability for users to send anonymous whispers to randomly selected users, fostering serendipitous connections while implementing comprehensive safety controls and user opt-out capabilities.
Foundation:
UI Placeholders: Include a "Send Mystery Whisper" option in the compose screen, initially disabled or hidden. A confirmation dialog will be present but inactive to explain random selection.
Convex Schema Extensions: The whispers table will include an optional isMystery field (boolean) to mark mystery whispers. A mysterySettings table will store user preferences for mystery whispers (opt-in/opt-out status).
Feature Flag: MYSTERY_WHISPERS (set to false for MVP).
Security & Privacy Considerations:
Random Selection Algorithm: Implement fair random user selection excluding blocked users and those who have opted out. Ensure no patterns that could lead to identification.
Opt-Out Mechanism: Users must have clear, easy-to-access settings to opt out of receiving mystery whispers, with immediate effect.
Rate Limiting: Implement strict rate limiting (e.g., maximum 3 mystery whispers per user per day) to prevent spam and ensure fair distribution.
Content Moderation: All mystery whispers must pass through basic content validation to prevent harassment or inappropriate content.
Anonymity Protection: Enhanced anonymity measures for mystery whispers to protect both sender and receiver privacy.
Performance Considerations: Optimize random user selection queries to maintain fast response times. Implement caching for user opt-out status to reduce database load.
UI/UX Requirements:
Opt-Out Settings: Clear toggle in user profile/settings for mystery whisper participation with immediate confirmation.
Compose Experience: Distinct UI flow for mystery whispers with clear explanation of random selection and anonymity guarantees.
Safety Messaging: Prominent warnings about appropriate content and consequences of misuse.
Feedback System: Post-send feedback showing approximate reach (e.g., "Sent to 1 random user") without revealing recipient details.

3.4. Data Specifications (Convex Schema)
The shared Convex backend will define the canonical data models, ensuring consistency across Web and ReactNative applications. This schema will be defined in Convex/schema.ts.

3.4.1. User Profile Data
Table Name: users
Purpose: Stores core user information.
Fields:
_id: (Convex ID, primary key, automatically generated)
clerkUserId: (string, unique, indexed) - Clerk's internal unique identifier for the user. Essential for linking Clerk accounts to Convex records.
email: (string, unique, indexed) - User's email address.
username: (string, unique, indexed) - A unique, user-friendly identifier. Initially derived from email.
displayName: (string, optional, default: same as username) - User's display name, editable in future.
profileImageUrl: (string, optional, default: placeholder URL, future feature) - URL to the user's profile picture.
bio: (string, optional, future feature) - A short description of the user.
pushNotificationToken: (string, optional, indexed, future feature, mobile only) - Device token for sending push notifications.
createdAt: (Convex timestamp, automatically managed) - Timestamp of user creation.
updatedAt: (Convex timestamp, automatically managed) - Timestamp of last update.

3.4.2. Whisper Data
Table Name: whispers
Purpose: Stores the one-way anonymous messages.
Fields:
_id: (Convex ID, primary key, automatically generated)
textContent: (string, max 280 characters) - The actual message content.
senderId: (Convex ID reference to users table, indexed) - The ID of the user who sent the whisper.
Note on Anonymity: While senderId is stored for internal linking and future features (like conversation evolution), Convex queries for recipients must ensure senderDisplayName is returned as "Anonymous" or a non-identifiable tag in the MVP.
receiverId: (Convex ID reference to users table, indexed) - The ID of the user who is the recipient of the whisper.
status: (enum: sent, delivered, read, default: sent) - Tracks the state of the whisper.
createdAt: (Convex timestamp, indexed, automatically managed) - Timestamp when the whisper was sent.
readAt: (Convex timestamp, optional) - Timestamp when the whisper was read by the recipient.
conversationId: (Convex ID reference to conversations table, optional, future feature) - Links to a conversation if the whisper has evolved.
imageUrl: (string, optional, future feature) - URL to an attached image.
location: (object: {latitude: number, longitude: number}, optional, future feature) - Location data, if explicitly shared with the whisper content.

3.4.3. Conversation Data (Future)
Table Name: conversations (feature-flagged by CONVERSATION_EVOLUTION)
Purpose: Stores information about two-way conversations that evolve from whispers.
Fields:
_id: (Convex ID, primary key, automatically generated)
participantIds: (array of Convex ID references to users table, indexed) - IDs of the users participating in the conversation.
initialWhisperId: (Convex ID reference to whispers table, unique) - The original whisper that initiated the conversation.
status: (enum: initiated, active, closed, default: initiated) - Current state of the conversation.
createdAt: (Convex timestamp, automatically managed)
updatedAt: (Convex timestamp, automatically managed)
3.4.4. Feature Flag Data
Table Name: featureFlags (Convex, internal, managed by admin)
Purpose: Stores the state of all feature flags, allowing remote toggling of features.
Fields:
_id: (Convex ID, primary key, automatically generated)
name: (string, unique, e.g., CONVERSATION_EVOLUTION) - The unique name of the feature flag.
enabled: (boolean) - true if the feature is enabled, false otherwise.
description: (string) - A brief explanation of the feature controlled by the flag.
