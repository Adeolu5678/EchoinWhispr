# AI Agent, implement the core MVP features as defined in SSD Section 3.1 User Authentication and SSD Section 3.2 Core Messaging: Whispers

2.1. User Authentication (FR-AUTH-001, FR-AUTH-002, FR-AUTH-003)
UI Components: Utilize Clerk's pre-built UI components for sign-up and sign-in wherever possible to accelerate development and ensure security.
For sign-up, use Clerk.mountSignUp() or <SignUp /> from Clerk's SDK, integrated into app/(auth)/sign-up.tsx.
For sign-in, use Clerk.mountSignIn() or <SignIn /> from Clerk's SDK, integrated into app/(auth)/sign-in.tsx.
Ensure these components are styled using Tailwind CSS classes via NativeWind to match the overall app theme.
Authentication Flow:
FR-AUTH-001 User Registration:
When a user successfully registers via Clerk's UI, capture the clerkUserId and email.
Trigger a Convex mutation (api.users.createInitialUser) to create a corresponding user record in Convex's users table. This Convex function will derive username (e.g., "user123") and displayName (initially same as username) from the email.
FR-AUTH-002 User Login: After successful login via Clerk, redirect the user to the main application home page (/) using router.replace('/').
FR-AUTH-003 Session Management: Rely entirely on Clerk's SDK for secure session management, token handling, and persistence across app launches.
Protected Routes: Implement authentication checks using useAuth() from Clerk within app/_layout.tsx or specific route group layouts (e.g., app/(tabs)/_layout.tsx) to redirect unauthenticated users to /sign-in.

2.2. Core Messaging: Whispers
2.2.1. Sending a Whisper (FR-WHISP-001)
UI:
Create a "Compose Whisper" screen accessible from a tab navigator (app/(tabs)/compose.tsx).
This screen will contain a React Native TextInput component for whisper content (multiline, max 280 characters with a dynamic character counter displayed below). Apply Tailwind CSS for styling.
Include another React Native TextInput for the recipient's username or email.
Provide a React Native TouchableOpacity or Button component labeled "Send Whisper", styled with Tailwind.
Logic:
Implement client-side validation for textContent (non-empty, max 280 characters) and recipientIdentifier (non-empty). Display immediate error messages.
Upon valid input and "Send Whisper" button press, call a Convex mutation (api.whispers.sendWhisper) with textContent and recipientIdentifier.
Display a transient success message (e.g., a custom toast component, as alert() is forbidden) and clear input fields.
Handle errors (network, Convex) by displaying clear error messages using a custom toast component.
Convex Mutation (api.whispers.sendWhisper):
This mutation will be defined in Convex/functions.ts and will:
Require ctx.auth.userId to be present (authentication check).
Accept textContent (string) and recipientIdentifier (string).
Perform server-side validation (e.g., v.string().min(1).max(280) for content).
Look up receiverId from the users table based on recipientIdentifier.
Insert a new record into the whispers table with textContent, senderId (from ctx.auth.userId), receiverId, and initial status: 'sent'.
2.2.2. Receiving & Displaying Whispers (FR-WHISP-002, FR-WHISP-003)
UI:
Create a main "Home/Whisper Inbox" screen (app/(tabs)/index.tsx).
Display whispers in a scrollable list, using a React Native FlatList component for efficient rendering.
Create a WhisperCard component (features/whispers/components/WhisperCard.tsx) for each whisper, styled with Tailwind.
Logic:
Use a Convex live query (api.whispers.getIncomingWhispers) to fetch whispers where receiverId matches ctx.auth.userId and status is not read. Order results by createdAt descending.
Implement real-time updates: as new whispers arrive via the live query, they should dynamically appear at the top of the FlatList without manual refresh.
Upon a whisper being viewed (e.g., after it becomes visible in the FlatList's onViewableItemsChanged callback or by user tap), call a Convex mutation (api.whispers.markWhisperAsRead) to update its status to read and set readAt.
WhisperCard UI:
Show textContent prominently using a React Native Text component.
Display createdAt timestamp (formatted for readability using utils/dateFormatter.ts).
Sender identity must be displayed as "Anonymoususing aText` component.
Include a subtle visual indicator for unread whispers (e.g., a distinct background color for unread cards using Tailwind classes).
Convex Query (api.whispers.getIncomingWhispers):
This query will be defined in Convex/functions.ts and will:
Require ctx.auth.userId to be present.
Fetch whispers where receiverId matches ctx.auth.userId.
Crucially, ensure senderId is NEVER directly returned to the client.
Return textContent, createdAt, status, and _id for each whisper.
Convex Mutation (api.whispers.markWhisperAsRead):
This mutation will be defined in Convex/functions.ts and will:
Require ctx.auth.userId to be present.
Accept whisperId (Convex ID).
Verify that ctx.auth.userId is indeed the receiverId of the specified whisper.
Update the whisper's status to read and set readAt to the current Convex timestamp.
